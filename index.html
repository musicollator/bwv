<!DOCTYPE html>
<html lang="en">

<!-- BWV Universal Player -->


<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/svg+xml" href="media/bach-seal.svg">
  <meta name="theme-color" content="#8B4513">
  <meta name="description" content="Interactive player for Bach's works with synchronized score highlighting">
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="manifest.json">
  
  <!-- iOS specific meta tags -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="BWV Player">
  <link rel="apple-touch-icon" href="media/icons/icon-192x192.png">
  
  <!-- Windows specific meta tags -->
  <meta name="msapplication-TileColor" content="#8B4513">
  <meta name="msapplication-TileImage" content="media/icons/icon-144x144.png">
  
  <title id="page-title">BWV Player</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"></script>
  <style>
    :root {
      --header-height: 120px;
      /* Will be updated from config */
    }

    /* SVG container positioning and scroll behavior */
    #svg-container {
      display: grid;
      place-items: start center;
      scroll-margin-top: var(--header-height);
    }

    #svg-container>svg {
      height: auto;
      max-width: 100%;
    }

    #svg-container>svg a[href] {
      color: black;
    }

    /* Note highlighting transitions - slow fade out for smooth visual */
    #svg-container>svg a[href] path {
      transition: fill 1.25s ease, filter 1.25s ease, transform 1.25s ease;
    }

    /* Fast fade in for immediate visual feedback */
    #svg-container>svg a[href].active path {
      transition: fill 0.15s linear, filter 0.15s linear, transform 0.15s linear;
    }

    /* Scale effect for active notes */
    body.playing #svg-container>svg a[href].active {
      transform-box: fill-box;
      transform-origin: center;
      transform: scale(1.25);
    }

    /* Bar highlights */
    body.playing:not(.seeking) #svg-container>svg rect[data-bar] {
      filter: none;
    }

    body:not(.playing) #svg-container>svg rect[data-bar] {
      visibility: hidden;
    }

    body.seeking #svg-container>svg rect[data-bar] {
      filter: blur(1rem) drop-shadow(0 0 0.2rem black);
    }

    /* Channel-specific colors for different instrument parts */
    body.playing #svg-container>svg a[href].active.channel-0 path {
      fill: coral !important;
      filter: drop-shadow(0 0 5px coral) drop-shadow(0 0 10px coral);
    }

    body.playing #svg-container>svg a[href].active.channel-1 path {
      fill: lightgreen !important;
      filter: drop-shadow(0 0 5px lightgreen) drop-shadow(0 0 10px lightgreen);
    }

    body.playing #svg-container>svg a[href].active.channel-2 path {
      fill: dodgerblue !important;
      filter: drop-shadow(0 0 5px dodgerblue) drop-shadow(0 0 10px dodgerblue);
    }

    body.playing #svg-container>svg a[href].active.channel-3 path {
      fill: gold !important;
      filter: drop-shadow(0 0 5px gold) drop-shadow(0 0 10px gold);
    }

    body.playing #svg-container>svg a[href].active.channel-4 path {
      fill: mediumpurple !important;
      filter: drop-shadow(0 0 5px mediumpurple) drop-shadow(0 0 10px mediumpurple);
    }

    body.playing #svg-container>svg a[href].active.channel-5 path {
      fill: lightpink !important;
      filter: drop-shadow(0 0 5px lightpink) drop-shadow(0 0 10px lightpink);
    }

    /* Hide scroll-to-top button when playing or already at optimal position */
    body.playing #button_scroll_to_top,
    body.svg-at-top #button_scroll_to_top {
      visibility: hidden !important;
    }

    #bar_spy {
      background-color: lightgray !important;
      color: black !important;
      font-weight: normal;
      font-size: .8rem;
      transition: filter 1s ease, width 1s ease;
    }

    body.seeking #bar_spy {
      filter: drop-shadow(0 0 0.2rem black);
      transition: filter .1s ease, width .1s ease;
    }

    body.seeking #bar_spy :first-child {
      display: inline-block;
      width: 24px;
      text-align: right;
    }

    footer#footer {
      visibility: hidden;
      z-index: 10;
    }

    /* Measure highlighting controls */
    #measure-controls {
      margin: 10px 0;
      padding: 10px;
      background-color: #f8f9fa;
      border-radius: 5px;
      border: 1px solid #dee2e6;
    }

    #measure-controls label {
      font-weight: 500;
      margin-right: 10px;
    }

    #measure-controls select {
      width: auto;
      min-width: 120px;
      display: inline-block;
      margin-left: 8px;
    }

    /* Hide dropdown arrow when disabled (single option) */
    #measure-controls select:disabled {
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      background-image: none;
      cursor: default;
    }
  </style>
</head>

<body>
  <!-- Sticky header with audio controls and navigation buttons -->
  <div class="sticky-top bg-light py-2 shadow-sm border-bottom">
    <div id="header" class="svg-at-top container-fluid text-center">
      <h2 class="d-flex align-items-center justify-content-center position-relative">
        <span id="work-title">Loading...</span>
        <!-- Wikipedia link button - positioned dynamically by JavaScript -->
        <a id="button_wikipedia" type="button" href="#" target="_blank" rel="noopener noreferrer"
          class="btn btn-outline-secondary btn-sm d-inline-flex align-items-center justify-content-center position-absolute rounded-circle" title=""
          style="visibility: hidden; width: 28px; height: 28px; border: 1px solid gray; right: 0;">
          <img src="media/Wikipedia's_W.svg" width="32" height="32" alt="Wikipedia"
            style="filter: brightness(0) saturate(100%) invert(50%) sepia(5%) saturate(388%) hue-rotate(314deg) brightness(89%) contrast(87%);">
        </a>
      </h2>
      <div class="d-flex align-items-center justify-content-center position-relative">
        <!-- Main audio player -->
        <audio id="audio" class="" style="flex-basis: 50%; max-width: 640px;" controls>
          <source id="audio-source" src="" type="audio/wav">
          Your browser does not support the audio element.
        </audio>
        <!-- Bar spy - positioned dynamically by JavaScript -->
        <div id="bar_spy" class="badge rounded-pill text-bg-secondary position-absolute" style="visibility: hidden;">
          <span id="current_bar">1</span>
          <span>of</span>
          <span id="total_bars">--</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading spinner - hidden after content loads -->
  <div id="loading" class="text-center my-5">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <div>Loading configuration and scoreâ€¦</div>
  </div>

  <!-- Main content area for musical notation -->
  <div class="container">

    <!-- Updated measure controls with fixed dropdown styling -->
    <div id="measure-controls" style="display: none;">
      <label for="highlight-select">Measure Highlighting:</label>
      <select id="highlight-select" class="form-select form-select-sm">
        <option value="">None</option>
      </select>
      <small id="highlight-info" class="text-muted ms-2" style="display: none;"></small>
    </div>

    <div id="svg-container"></div>

    <!-- Scroll-to-top button - auto-hides when not needed -->
    <a id="button_scroll_to_top" type="button" class="btn btn-outline-secondary mx-2 btn-sm d-inline-flex align-items-center justify-content-center"
      style="position: fixed; visibility: hidden; width: 24px; height: 24px; border: 1px solid gray; z-index: 1000;" title="scroll_to_top"
      onclick="document.getElementById('svg-container').scrollIntoView({ behavior: 'smooth', block: 'start'}); return false;">
      <img src="media/up-arrow-svgrepo-com.svg" width="16" height="16" alt="scroll_up"
        style="filter: brightness(0) saturate(100%) invert(50%) sepia(5%) saturate(388%) hue-rotate(314deg) brightness(89%) contrast(87%);">
    </a>
  </div>

  <footer id="footer" class="bg-light footer mt-auto py-1 d-flex flex-wrap justify-content-evenly shadow-sm border-top">
    <div class="ms-2" style="margin: auto 0;">
      <span class="text-muted" style="margin-top: auto; font-size: small;">
        <span>Â© 2025 Christophe Thiebaud</span>
      </span>
    </div>
  </footer>

  <script type="module" src="index.js"></script>
  
  <!-- PWA Service Worker Registration -->
  <script>
    // Register service worker for PWA functionality
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
          .then((registration) => {
            console.log('âœ… Service Worker registered successfully:', registration.scope);
            
            // Check for service worker updates
            registration.addEventListener('updatefound', () => {
              const newWorker = registration.installing;
              newWorker.addEventListener('statechange', () => {
                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                  // New version available
                  console.log('ðŸ”„ New version available - reload to update');
                  // Optionally show update notification to user
                  showUpdateNotification();
                }
              });
            });
          })
          .catch((error) => {
            console.log('âŒ Service Worker registration failed:', error);
          });
      });
    }

    // Optional: Show update notification
    function showUpdateNotification() {
      // You can customize this notification
      if (confirm('A new version of BWV Player is available. Reload to update?')) {
        window.location.reload();
      }
    }

    // PWA install prompt handling
    let deferredPrompt;
    
    window.addEventListener('beforeinstallprompt', (e) => {
      console.log('ðŸ’¾ PWA install prompt available');
      e.preventDefault();
      deferredPrompt = e;
      
      // Optionally show custom install button
      showInstallButton();
    });

    function showInstallButton() {
      // Create install button (you can customize this)
      const installBtn = document.createElement('button');
      installBtn.className = 'btn btn-primary btn-sm position-fixed';
      installBtn.style.cssText = 'top: 10px; right: 10px; z-index: 1100;';
      installBtn.innerHTML = 'ðŸ“± Install App';
      installBtn.onclick = installPWA;
      
      document.body.appendChild(installBtn);
      
      // Auto-hide after 10 seconds
      setTimeout(() => {
        if (installBtn.parentNode) {
          installBtn.remove();
        }
      }, 10000);
    }

    async function installPWA() {
      if (!deferredPrompt) return;
      
      deferredPrompt.prompt();
      const { outcome } = await deferredPrompt.userChoice;
      
      console.log(`PWA install prompt outcome: ${outcome}`);
      deferredPrompt = null;
      
      // Remove install button
      document.querySelector('button[onclick="installPWA()"]')?.remove();
    }

    // Track PWA usage
    window.addEventListener('appinstalled', (evt) => {
      console.log('ðŸŽ‰ BWV Player installed as PWA');
    });
  </script>
</body>

</html>